{
  "info": {
    "name": "Lensor Payment API",
    "_postman_id": "lensor-payment-collection",
    "description": "Complete payment flow for VNPay and PayPal integration with SPA architecture",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{jwt_token}}",
        "type": "string"
      }
    ]
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:3005",
      "type": "string"
    },
    {
      "key": "jwt_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "vnpay_order_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "paypal_order_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "paypal_token",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "0. Authentication",
      "item": [
        {
          "name": "Login",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200 || pm.response.code === 201) {",
                  "    const response = pm.response.json();",
                  "    if (response.access_token) {",
                  "        pm.collectionVariables.set('jwt_token', response.access_token);",
                  "        console.log('âœ… JWT Token saved to collection variable');",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"your@email.com\",\n  \"password\": \"yourpassword\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/auth/login",
              "host": ["{{base_url}}"],
              "path": ["auth", "login"]
            },
            "description": "Login to get JWT token. The token will be automatically saved to collection variable."
          },
          "response": []
        }
      ],
      "description": "Authentication endpoints"
    },
    {
      "name": "1. VNPay Flow",
      "item": [
        {
          "name": "1.1 Create VNPay Payment",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200 || pm.response.code === 201) {",
                  "    const response = pm.response.json();",
                  "    if (response.data && response.data.orderId) {",
                  "        pm.collectionVariables.set('vnpay_order_id', response.data.orderId);",
                  "        console.log('âœ… VNPay Order ID saved:', response.data.orderId);",
                  "    }",
                  "    if (response.data && response.data.paymentUrl) {",
                  "        console.log('ðŸ”— Payment URL:', response.data.paymentUrl);",
                  "        console.log('ðŸ“‹ Copy and open this URL in browser to complete payment');",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"amount\": 100000,\n  \"orderInfo\": \"Payment for Lightroom Presets\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/payment/vnpay/create",
              "host": ["{{base_url}}"],
              "path": ["payment", "vnpay", "create"]
            },
            "description": "**STEP 1: Create VNPay Payment**\n\n1. Send request to create payment\n2. Copy `paymentUrl` from response\n3. Open URL in browser\n4. Use test card:\n   - Card: 9704198526191432198\n   - Holder: NGUYEN VAN A\n   - Date: 07/15\n   - OTP: 123456\n5. After payment, VNPay redirects to frontend with query params\n6. Frontend calls verify endpoint with those params"
          },
          "response": []
        },
        {
          "name": "1.2 Verify VNPay Payment (Frontend calls this)",
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"vnp_TmnCode\": \"LDY7BZ35\",\n  \"vnp_Amount\": \"10000000\",\n  \"vnp_BankCode\": \"NCB\",\n  \"vnp_BankTranNo\": \"VNP01234567\",\n  \"vnp_CardType\": \"ATM\",\n  \"vnp_PayDate\": \"20231111220000\",\n  \"vnp_OrderInfo\": \"Payment for Lightroom Presets\",\n  \"vnp_TransactionNo\": \"14234567\",\n  \"vnp_ResponseCode\": \"00\",\n  \"vnp_TransactionStatus\": \"00\",\n  \"vnp_TxnRef\": \"{{vnpay_order_id}}\",\n  \"vnp_SecureHash\": \"paste_secure_hash_from_callback_here\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/payment/verify-vnpay",
              "host": ["{{base_url}}"],
              "path": ["payment", "verify-vnpay"]
            },
            "description": "**STEP 2: Verify VNPay Payment (Called by Frontend)**\n\nAfter user completes payment on VNPay:\n1. VNPay redirects to: `http://localhost:3000/payment/return?vnp_xxx=...`\n2. Frontend extracts all `vnp_*` query params\n3. Frontend sends all params to this endpoint\n4. Backend verifies signature and updates order status\n5. Frontend shows success/failure based on response\n\n**Note:** Replace the body with actual callback params from VNPay redirect URL"
          },
          "response": []
        },
        {
          "name": "1.3 VNPay Return URL (Browser redirect)",
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/payment/vnpay-return?vnp_TmnCode=LDY7BZ35&vnp_Amount=10000000&vnp_ResponseCode=00",
              "host": ["{{base_url}}"],
              "path": ["payment", "vnpay-return"],
              "query": [
                {
                  "key": "vnp_TmnCode",
                  "value": "LDY7BZ35"
                },
                {
                  "key": "vnp_Amount",
                  "value": "10000000"
                },
                {
                  "key": "vnp_ResponseCode",
                  "value": "00"
                }
              ]
            },
            "description": "**This is called by VNPay (Browser redirect)**\n\nDO NOT call this manually in Postman.\nThis endpoint receives the callback from VNPay and redirects to frontend.\n\n**Flow:**\n1. User completes payment on VNPay\n2. VNPay redirects browser to this endpoint\n3. Backend verifies payment\n4. Backend redirects to frontend success/failure page"
          },
          "response": []
        }
      ],
      "description": "VNPay payment flow following SPA architecture"
    },
    {
      "name": "2. PayPal Flow",
      "item": [
        {
          "name": "2.1 Create PayPal Payment",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200 || pm.response.code === 201) {",
                  "    const response = pm.response.json();",
                  "    if (response.data && response.data.orderId) {",
                  "        pm.collectionVariables.set('paypal_order_id', response.data.orderId);",
                  "        console.log('âœ… PayPal Order ID saved:', response.data.orderId);",
                  "    }",
                  "    if (response.data && response.data.paypalOrderId) {",
                  "        pm.collectionVariables.set('paypal_token', response.data.paypalOrderId);",
                  "        console.log('âœ… PayPal Token saved:', response.data.paypalOrderId);",
                  "    }",
                  "    if (response.data && response.data.paymentUrl) {",
                  "        console.log('ðŸ”— Payment URL:', response.data.paymentUrl);",
                  "        console.log('ðŸ“‹ Copy and open this URL in browser to complete payment');",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"amount\": 100000,\n  \"orderInfo\": \"Purchase Lightroom Presets Pack\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/payment/paypal/create",
              "host": ["{{base_url}}"],
              "path": ["payment", "paypal", "create"]
            },
            "description": "**STEP 1: Create PayPal Payment**\n\n1. Send request to create payment\n2. Copy `paymentUrl` from response\n3. Open URL in browser\n4. Login with PayPal sandbox account:\n   - Email: sb-tbt4q47331523@personal.example.com\n   - Password: Nd8f=2>X\n5. Approve payment\n6. PayPal redirects to frontend with token and orderId\n7. Frontend calls verify endpoint with those params\n\n**Note:** Amount in VND will be converted to USD (rate: 23000)"
          },
          "response": []
        },
        {
          "name": "2.2 Verify PayPal Payment (Frontend calls this)",
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"token\": \"{{paypal_token}}\",\n  \"orderId\": \"{{paypal_order_id}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/payment/verify-paypal",
              "host": ["{{base_url}}"],
              "path": ["payment", "verify-paypal"]
            },
            "description": "**STEP 2: Verify PayPal Payment (Called by Frontend)**\n\nAfter user approves payment on PayPal:\n1. PayPal redirects to: `http://localhost:3000/payment/return?token=xxx&orderId=yyy`\n2. Frontend extracts `token` and `orderId` from query params\n3. Frontend sends both to this endpoint\n4. Backend captures payment and updates order status\n5. Frontend shows success/failure based on response\n\n**Note:** This endpoint triggers the actual money capture from PayPal"
          },
          "response": []
        },
        {
          "name": "2.3 PayPal Return URL (Browser redirect)",
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/payment/paypal-return?token={{paypal_token}}&orderId={{paypal_order_id}}",
              "host": ["{{base_url}}"],
              "path": ["payment", "paypal-return"],
              "query": [
                {
                  "key": "token",
                  "value": "{{paypal_token}}"
                },
                {
                  "key": "orderId",
                  "value": "{{paypal_order_id}}"
                }
              ]
            },
            "description": "**This is called by PayPal (Browser redirect)**\n\nDO NOT call this manually in Postman.\nThis endpoint receives the callback from PayPal and redirects to frontend.\n\n**Flow:**\n1. User approves payment on PayPal\n2. PayPal redirects browser to this endpoint\n3. Backend captures payment\n4. Backend redirects to frontend success/failure page"
          },
          "response": []
        },
        {
          "name": "2.4 PayPal Cancel URL (Browser redirect)",
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/payment/paypal-cancel?orderId={{paypal_order_id}}",
              "host": ["{{base_url}}"],
              "path": ["payment", "paypal-cancel"],
              "query": [
                {
                  "key": "orderId",
                  "value": "{{paypal_order_id}}"
                }
              ]
            },
            "description": "**This is called by PayPal when user cancels**\n\nDO NOT call this manually in Postman.\nThis endpoint receives the cancel callback from PayPal.\n\n**Flow:**\n1. User clicks 'Cancel' on PayPal\n2. PayPal redirects browser to this endpoint\n3. Backend updates order status to cancelled\n4. Backend redirects to frontend cancelled page"
          },
          "response": []
        }
      ],
      "description": "PayPal payment flow following SPA architecture"
    },
    {
      "name": "3. Unified Payment Endpoint",
      "item": [
        {
          "name": "3.1 Create Payment (Unified)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200 || pm.response.code === 201) {",
                  "    const response = pm.response.json();",
                  "    if (response.data && response.data.orderId) {",
                  "        const channel = pm.request.body.raw ? JSON.parse(pm.request.body.raw).paymentChannel : 'unknown';",
                  "        if (channel === 'vnpay') {",
                  "            pm.collectionVariables.set('vnpay_order_id', response.data.orderId);",
                  "            console.log('âœ… VNPay Order ID saved:', response.data.orderId);",
                  "        } else if (channel === 'paypal') {",
                  "            pm.collectionVariables.set('paypal_order_id', response.data.orderId);",
                  "            pm.collectionVariables.set('paypal_token', response.data.paypalOrderId);",
                  "            console.log('âœ… PayPal Order ID saved:', response.data.orderId);",
                  "            console.log('âœ… PayPal Token saved:', response.data.paypalOrderId);",
                  "        }",
                  "    }",
                  "    if (response.data && response.data.paymentUrl) {",
                  "        console.log('ðŸ”— Payment URL:', response.data.paymentUrl);",
                  "        console.log('ðŸ“‹ Copy and open this URL in browser to complete payment');",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"amount\": 100000,\n  \"paymentChannel\": \"vnpay\",\n  \"orderInfo\": \"Purchase Lightroom Presets\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/payment/create",
              "host": ["{{base_url}}"],
              "path": ["payment", "create"]
            },
            "description": "**Unified Payment Endpoint (Recommended)**\n\nCreate payment for any channel with single endpoint.\n\n**Request Body:**\n```json\n{\n  \"amount\": 100000,\n  \"paymentChannel\": \"vnpay\" or \"paypal\",\n  \"orderInfo\": \"Payment description\"\n}\n```\n\n**Flow:**\n1. Change `paymentChannel` to `vnpay` or `paypal`\n2. Send request\n3. Copy paymentUrl and open in browser\n4. Complete payment\n5. Use verify endpoint for selected channel"
          },
          "response": []
        }
      ],
      "description": "Single endpoint for both VNPay and PayPal payments"
    }
  ]
}
